<!doctype html>
<html>
<head>
	<meta charset="utf8">
	<title></title>
</head>
<body>



	<script type="text/javascript" >
		window.scenes = []
		window.started = false

		var createArena = function(size){
			var canvas = document.createElement('canvas')
			canvas.height = size.height
			canvas.width = size.width
			canvas.backgroundColor = 'wheat'
			document.body.appendChild(canvas)

			return canvas
		}

		var botWidth = 20
		var botHeight = 20

		var botBox = function(coords){
			return [
				coords.x - botWidth/2,
				arena.height - coords.y - botHeight/2,
				botWidth,
				botHeight
			]
		}

		var healthColor = function(health) {
			var r = 0
			var g = 0
			var b = 0

			var g = 255 * health / 150
			var r = 255 - 255 * health / 150


			return 'rgb('+r+','+g+','+b+')'
		}

		var drawBots = function(arena, bots){
			var ctx = arena.getContext('2d')
			ctx.fillStyle = 'black'
			ctx.fillRect(0, 0, arena.width, arena.height)

			bots.forEach(function(bot){
				if (bot.dead)
					return

				ctx.save();
				ctx.beginPath();
				// ctx.translate(bot.position.x, bot.position.y);
				// ctx.rotate(bot.heading);
				ctx.rect.apply(ctx, botBox(bot.position));
				ctx.fillStyle = healthColor(bot.health);
				ctx.fill();
				ctx.lineWidth = 2;
				ctx.strokeStyle = "wheat";
				ctx.stroke();
				ctx.closePath();

				ctx.font = '10px arial'
				ctx.fillStyle = 'black'
				ctx.fillText(bot.health.toFixed(0), bot.position.x - botWidth/2, arena.height - bot.position.y)

				ctx.restore();

			})
		}

		var drawShells = function(arena, shells){
			var ctx = arena.getContext('2d')

			shells.forEach(function(shell){
				ctx.save();
				ctx.beginPath();
				ctx.arc(shell.position.x, arena.height - shell.position.y, 2, 0, 2*Math.PI);
				ctx.fillStyle = 'maroon';
				ctx.fill();
				ctx.lineWidth = 1;
				ctx.strokeStyle = "wheat";
				ctx.stroke();
				ctx.closePath();
				ctx.restore();
			})
		}

		var drawExplosions = function(arena, explosions){
			var ctx = arena.getContext('2d')

			explosions.forEach(function(explosion){
				ctx.save();
				ctx.beginPath();
				ctx.arc(explosion.position.x, arena.height - explosion.position.y, 20, 0, 2*Math.PI);
				ctx.fillStyle = 'white';
				ctx.fill();
				ctx.lineWidth = 1;
				ctx.strokeStyle = "wheat";
				ctx.stroke();
				ctx.closePath();
				ctx.restore();
			})
		}


		var play = function(){
			if (scenes.length > 0){
				var currentScene = scenes.shift()
				drawBots(arena, currentScene.bots)
				drawShells(arena, currentScene.shells)
				drawExplosions(arena, currentScene.explosions)
			}

			setTimeout(play, 20)
		}

		var ws = new WebSocket('ws://__HOST__:__PORT__')

		ws.onmessage = function(e){
			try {
				var parsedData = JSON.parse(e.data)
				// console.log(parsedData)

				if (parsedData.arena)
					window.arena = createArena(parsedData.arena)

				if (parsedData.tick){
					scenes.push(parsedData.scene)

					if (!started && scenes.length > 50){
						play()
						started = true
					}
				}

			}
			catch(error){
				console.error(error)
				console.log(e.data)
			}
		}

		ws.onclose = function(e){
			console.log('closed connection to server')
			console.log(e)
		}

		// ws.onopen = function(){
		// 	ws.send('hello')
		// }

	</script>
</body>
</html>
